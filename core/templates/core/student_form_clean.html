{% extends 'core/base.html' %}
{% load static form_tags %}

{% block extra_head %}
<style>
  /* Modern Autocomplete Combobox Styles */
  #class_autocomplete {
    transition: all 0.2s ease;
  }
  
  #class_autocomplete:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  #class_suggestions {
    animation: slideDown 0.2s ease;
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: background-color 0.15s ease;
    direction: rtl;
    text-align: right;
    border-bottom: 1px solid #f3f4f6;
  }
  
  .suggestion-item:last-child {
    border-bottom: none;
  }
  
  .suggestion-item:hover,
  .suggestion-item.selected {
    background-color: #eff6ff;
  }
  
  .suggestion-item.selected {
    background-color: #dbeafe;
    font-weight: 500;
  }
  
  .no-results {
    padding: 16px;
    text-align: center;
    color: #6b7280;
    font-size: 14px;
  }
  
  .loading {
    padding: 16px;
    text-align: center;
    color: #6b7280;
    font-size: 14px;
  }
</style>
{% endblock %}

{% block content %}
  <div class="bg-white p-6 rounded-xl shadow-md ring-1 ring-gray-200">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold">ثبت دانش‌آموز جدید</h2>
        <p class="text-sm text-gray-500">فرم ثبت اطلاعات پایه دانش‌آموزان مرکز</p>
      </div>
      <div class="hidden sm:flex items-center gap-3">
        <a href="{% url 'core:student_list' %}" class="text-sm text-blue-600 hover:underline">بازگشت به لیست</a>
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
      {% csrf_token %}

      <!-- Left: image upload -->
      <div class="md:col-span-1 flex flex-col items-center">
        <label class="block text-sm font-medium text-gray-700 mb-3">عکس دانش‌آموز</label>

        <div class="w-44 h-44 bg-gray-50 rounded-lg flex items-center justify-center overflow-hidden border border-dashed border-gray-200">
          <img id="preview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><rect fill='%23f3f4f6' width='200' height='200'/><g transform='translate(50,30)'><circle cx='50' cy='40' r='30' fill='%23e5e7eb'/><rect x='20' y='90' width='60' height='20' rx='10' fill='%23e5e7eb'/></g></svg>" alt="پیش‌نمایش" class="w-full h-full object-cover" />
        </div>

        <label for="id_image" class="mt-3 w-full inline-flex justify-center items-center px-3 py-2 bg-white border rounded-md text-sm text-gray-700 hover:bg-gray-50 cursor-pointer">
          انتخاب فایل
        </label>
        {{ form.image }}

        <p class="text-xs text-gray-400 mt-2">فرمت‌های مجاز: JPG, PNG — حداکثر 2MB</p>
      </div>

      <!-- Right: inputs -->
      <div class="md:col-span-2 space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">نام و نام خانوادگی</label>
            {{ form.name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.name.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.name.errors|striptags }}</p>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">نام پدر</label>
            {{ form.father_name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.father_name.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.father_name.errors|striptags }}</p>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">نام پدر کلان</label>
            {{ form.grandfather_name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.grandfather_name.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.grandfather_name.errors|striptags }}</p>
            {% endif %}
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">سکونت فعلی</label>
            {{ form.current_address|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.current_address.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.current_address.errors|striptags }}</p>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">سکونت اصلی</label>
            {{ form.permanent_address|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.permanent_address.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.permanent_address.errors|striptags }}</p>
            {% endif %}
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">تایم</label>
          <div class="mt-1 grid grid-cols-2 gap-2 items-center">
            <div>
              <label class="block text-xs text-gray-600">تایم آغاز</label>
              {{ form.time_start|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
            </div>
            <div>
              <label class="block text-xs text-gray-600">تایم ختم</label>
              {{ form.time_end|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">نمبر تذکره</label>
              {{ form.id_number|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">جنسیت</label>
              {{ form.gender|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">نمبر امتحان کانکور</label>
              {{ form.exam_number|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mt-4">صنف</label>
            <div class="relative mt-1">
              <!-- Hidden field for ForeignKey ID -->
              <input type="hidden" id="id_school_class" name="school_class" value="{% if form.instance.school_class %}{{ form.instance.school_class.id }}{% endif %}">
              
              <!-- Visible autocomplete input -->
              <input 
                type="text" 
                id="class_autocomplete" 
                autocomplete="off"
                placeholder="صنف را تایپ کنید..."
                value="{% if form.instance.school_class %}{{ form.instance.school_class.name }}{% endif %}"
                class="block w-full rounded-md border-gray-300 border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:ring-2 px-4 py-2.5 text-base"
                style="direction: rtl;">
              
              <!-- Suggestions dropdown -->
              <div id="class_suggestions" class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-60 overflow-auto">
                <!-- Suggestions will be populated here -->
              </div>
            </div>
            {% if form.school_class.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.school_class.errors|striptags }}</p>
            {% endif %}
          </div>

          <label class="block text-sm font-medium text-gray-700 mt-4">شماره موبایل</label>
          {{ form.mobile_number|add_class:'mt-1 block w-1/2 rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
          {% if form.mobile_number.errors %}
            <p class="text-xs text-red-600 mt-1">{{ form.mobile_number.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="pt-2 flex items-center gap-3">
          <button type="submit" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">ثبت دانش‌آموز</button>
          <a href="{% url 'core:student_list' %}" class="inline-flex items-center gap-2 border border-gray-300 px-4 py-2 rounded-md text-gray-700">انصراف</a>
        </div>
      </div>
    </form>
  </div>


{% block extra_js %}
<script>
  (function(){
    const fileInput = document.querySelector('#id_image');
    const preview = document.getElementById('preview');
    if (!fileInput) return;

    // hide default file input (it's already rendered by Django field)
    fileInput.classList.add('hidden');

    fileInput.addEventListener('change', function(e){
      const file = this.files && this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){ preview.src = ev.target.result; };
      reader.readAsDataURL(file);
    });
  })();
</script>

<script>
(function() {
  // Professional Autocomplete Combobox - Like Google, Amazon, etc.
  const input = document.getElementById('class_autocomplete');
  const hiddenInput = document.getElementById('id_school_class');
  const suggestionsContainer = document.getElementById('class_suggestions');
  
  let currentFocus = -1;
  let searchTimeout = null;
  let currentSuggestions = [];
  
  // Fetch suggestions from server
  async function fetchSuggestions(query) {
    if (!query || query.trim().length === 0) {
      hideSuggestions();
      return;
    }
    
    try {
      showLoading();
      
      const response = await fetch(`{% url 'core:api_class_search' %}?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      currentSuggestions = data.results;
      displaySuggestions(data.results);
    } catch (error) {
      console.error('Error fetching suggestions:', error);
      showError();
    }
  }
  
  // Display suggestions in dropdown
  function displaySuggestions(suggestions) {
    suggestionsContainer.innerHTML = '';
    
    if (suggestions.length === 0) {
      suggestionsContainer.innerHTML = '<div class="no-results">هیچ صنفی یافت نشد</div>';
      suggestionsContainer.classList.remove('hidden');
      return;
    }
    
    suggestions.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.textContent = item.text;
      div.dataset.id = item.id;
      div.dataset.text = item.text;
      div.dataset.index = index;
      
      // Mouse click
      div.addEventListener('click', () => selectSuggestion(item.id, item.text));
      
      // Mouse hover
      div.addEventListener('mouseenter', () => {
        removeActiveClass();
        div.classList.add('selected');
        currentFocus = index;
      });
      
      suggestionsContainer.appendChild(div);
    });
    
    suggestionsContainer.classList.remove('hidden');
  }
  
  // Show loading state
  function showLoading() {
    suggestionsContainer.innerHTML = '<div class="loading">در حال جستجو...</div>';
    suggestionsContainer.classList.remove('hidden');
  }
  
  // Show error state
  function showError() {
    suggestionsContainer.innerHTML = '<div class="no-results">خطا در بارگذاری</div>';
    suggestionsContainer.classList.remove('hidden');
  }
  
  // Hide suggestions
  function hideSuggestions() {
    suggestionsContainer.classList.add('hidden');
    currentFocus = -1;
  }
  
  // Select a suggestion
  function selectSuggestion(id, text) {
    input.value = text;
    hiddenInput.value = id;
    hideSuggestions();
    input.blur();
  }
  
  // Remove active class from all items
  function removeActiveClass() {
    const items = suggestionsContainer.querySelectorAll('.suggestion-item');
    items.forEach(item => item.classList.remove('selected'));
  }
  
  // Input event - trigger search
  input.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    
    const query = this.value.trim();
    
    // Clear hidden input if user clears the text
    if (query === '') {
      hiddenInput.value = '';
      hideSuggestions();
      return;
    }
    
    // Debounce: wait 300ms after user stops typing
    searchTimeout = setTimeout(() => {
      fetchSuggestions(query);
    }, 300);
  });
  
  // Keyboard navigation
  input.addEventListener('keydown', function(e) {
    const items = suggestionsContainer.querySelectorAll('.suggestion-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      currentFocus++;
      if (currentFocus >= items.length) currentFocus = 0;
      addActiveClass(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      currentFocus--;
      if (currentFocus < 0) currentFocus = items.length - 1;
      addActiveClass(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (currentFocus > -1 && items[currentFocus]) {
        items[currentFocus].click();
      }
    } else if (e.key === 'Escape') {
      hideSuggestions();
    }
  });
  
  // Add active class to current item
  function addActiveClass(items) {
    removeActiveClass();
    if (currentFocus >= items.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = items.length - 1;
    items[currentFocus].classList.add('selected');
    items[currentFocus].scrollIntoView({ block: 'nearest' });
  }
  
  // Close suggestions when clicking outside
  document.addEventListener('click', function(e) {
    if (e.target !== input && e.target !== suggestionsContainer) {
      hideSuggestions();
    }
  });
  
  // Focus event - show suggestions if there's text
  input.addEventListener('focus', function() {
    if (this.value.trim().length > 0) {
      fetchSuggestions(this.value.trim());
    }
  });
})();
</script>
{% endblock %}

{% endblock %}
