{% extends 'core/base.html' %}
{% load static %}

{% block content %}
  <h1 class="text-2xl font-bold mb-4">داشبورد</h1>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Students -->
    <div class="bg-white p-4 rounded-xl shadow hover:shadow-md transform hover:-translate-y-1 transition">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 flex items-center justify-center rounded-full text-white" style="background: linear-gradient(135deg,#6EE7B7 0%,#3B82F6 100%);">
          <i data-lucide="users" class="w-7 h-7"></i>
        </div>
        <div>
          <div class="text-sm text-gray-500">کل دانش‌آموزان</div>
          <div class="text-3xl font-semibold">{{ total_students }}</div>
        </div>
      </div>
    </div>

    <!-- Teachers -->
    <div class="bg-white p-4 rounded-xl shadow hover:shadow-md transform hover:-translate-y-1 transition">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 flex items-center justify-center rounded-full text-white" style="background: linear-gradient(135deg,#FDE68A 0%,#F97316 100%);">
          <i data-lucide="user-check" class="w-7 h-7"></i>
        </div>
        <div>
          <div class="text-sm text-gray-500">کل اساتید</div>
          <div class="text-3xl font-semibold">{{ total_teachers }}</div>
        </div>
      </div>
    </div>

    <!-- Subjects -->
    <div class="bg-white p-4 rounded-xl shadow hover:shadow-md transform hover:-translate-y-1 transition">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 flex items-center justify-center rounded-full text-white" style="background: linear-gradient(135deg,#A78BFA 0%,#60A5FA 100%);">
          <i data-lucide="book-open" class="w-7 h-7"></i>
        </div>
        <div>
          <div class="text-sm text-gray-500">کل مضامین</div>
          <div class="text-3xl font-semibold">{{ total_subjects }}</div>
        </div>
      </div>
    </div>

    <!-- Classes -->
    <div class="bg-white p-4 rounded-xl shadow hover:shadow-md transform hover:-translate-y-1 transition">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 flex items-center justify-center rounded-full text-white" style="background: linear-gradient(135deg,#FCA5A5 0%,#F97316 100%);">
          <i data-lucide="layers" class="w-7 h-7"></i>
        </div>
        <div>
          <div class="text-sm text-gray-500">کل صنوف</div>
          <div class="text-3xl font-semibold">{{ total_classes }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-lg font-medium mb-2">تقسیم دانش‌آموزان براساس صنف</h2>
    <p class="text-sm text-gray-500 mb-4">نمودار دایره‌ای درصد دانش‌آموزان در هر صنف</p>
    <div class="max-w-md mx-auto">
      <canvas id="studentsPie" width="400" height="400"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- embed chart JSON safely in the page to avoid direct template tokens inside JS -->
  <script id="chart-data" type="application/json">{{ chart_json }}</script>
  <script>
    (function(){
      const el = document.getElementById('chart-data');
      let chartData = {labels: [], data: []};
      try{
        chartData = JSON.parse(el ? el.textContent : '{}') || chartData;
      }catch(e){
        console.error('Failed to parse chart data', e);
      }

      const ctx = document.getElementById('studentsPie').getContext('2d');
      const backgroundColors = (chartData.labels || []).map((_, i) => {
        const hues = [220, 200, 180, 160, 140, 120, 100, 80, 60, 40];
        const h = hues[i % hues.length];
        return `hsl(${h} 70% 70%)`;
      });

      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: chartData.labels,
          datasets: [{
            data: chartData.data,
            backgroundColor: backgroundColors,
            borderWidth: 1,
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    })();
  </script>

  <!-- lucide icons -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      try{
        if (window.lucide && typeof lucide.createIcons === 'function') lucide.createIcons();
      }catch(e){ console.error('lucide init failed', e); }
    });
  </script>
  <!-- Fallback: if lucide doesn't load (CDN blocked/offline/CSP), inject minimal inline SVGs for our icons -->
  <script>
    (function(){
      function svg(str){
        const div = document.createElement('div');
        div.innerHTML = str.trim();
        return div.firstChild;
      }

      const icons = {
        'users': '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
        'user-check': '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M17 11l2 2 4-4"></path></svg>',
        'book-open': '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 7a2 2 0 0 1 2-2h7v14H4a2 2 0 0 1-2-2z"></path><path d="M22 7a2 2 0 0 0-2-2h-7v14h7a2 2 0 0 0 2-2z"></path></svg>',
        'layers': '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>'
      };

      // run after a short delay to allow lucide to replace if available
      window.setTimeout(function(){
        if (window.lucide && typeof lucide.createIcons === 'function') return; // lucide present

        document.querySelectorAll('[data-lucide]').forEach(function(el){
          const name = el.getAttribute('data-lucide');
          const fallback = icons[name];
          if (!fallback) return;
          try{
            const svgEl = svg(fallback);
            // preserve color by adding the same text-color class if present on parent
            if (el.className) svgEl.className.baseVal = el.className;
            el.replaceWith(svgEl);
          }catch(e){ /* ignore */ }
        });
      }, 300);
    })();
  </script>

{% endblock %}
