{% extends 'core/base.html' %}
{% load static %}

{% block extra_head %}
<style>
  /* Professional Student Selection Styling */
  .student-search-container {
    position: relative;
    max-width: 600px;
  }
  
  #student-display {
    padding: 14px 48px 14px 16px;
    font-size: 16px;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    transition: all 0.2s ease;
    background-color: #ffffff;
    direction: rtl;
  }
  
  #student-display:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }
  
  #student-display::placeholder {
    color: #9ca3af;
    font-size: 14px;
  }
  
  .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    pointer-events: none;
    z-index: 10;
  }
  
  #student-suggestions {
    margin-top: 8px;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    animation: slideDown 0.2s ease;
    width: calc(100% - 48px);
    left: auto;
    right: 0;
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .student-suggestion-item {
    padding: 14px 16px;
    cursor: pointer;
    transition: all 0.15s ease;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    align-items: center;
    gap: 12px;
    direction: rtl;
  }
  
  .student-suggestion-item:last-child {
    border-bottom: none;
  }
  
  .student-suggestion-item:hover {
    background: linear-gradient(to left, #eff6ff, #ffffff);
  }
  
  .student-suggestion-item.selected {
    background: linear-gradient(to left, #dbeafe, #eff6ff);
    font-weight: 500;
  }
  
  .student-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
    flex-shrink: 0;
  }
  
  .student-info {
    flex: 1;
    min-width: 0;
  }
  
  .student-name {
    font-weight: 500;
    color: #1f2937;
    font-size: 15px;
  }
  
  .student-meta {
    font-size: 13px;
    color: #6b7280;
    margin-top: 2px;
  }
  
  .no-results-message {
    padding: 24px;
    text-align: center;
    color: #6b7280;
  }
  
  .no-results-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.5;
  }
  
  .selected-student-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    margin-top: 12px;
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  
  .selection-label {
    font-size: 15px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .required-badge {
    background: #fee2e2;
    color: #991b1b;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-xl shadow-md ring-1 ring-gray-200">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold">Ø«Ø¨Øª Ù†Ù…Ø±Ø§Øª</h2>
      <p class="text-sm text-gray-500">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ØŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¶Ø§Ù…ÛŒÙ† Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù†Ù…Ø±Ø§Øª</p>
    </div>
    <div class="hidden sm:flex items-center gap-3">
      <a href="{% url 'core:student_list' %}" class="text-sm text-blue-600 hover:underline">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</a>
    </div>
  </div>

  <form method="post" id="grades-form" class="space-y-4">
    {% csrf_token %}

    <!-- Professional Student Selection -->
    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-100" style="overflow: visible; position: relative;">
      <label class="selection-label">
        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
      </label>
      
      <div class="student-search-container">
        <input 
          type="text" 
          id="student-display" 
          placeholder="Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯..." 
          class="mt-1 block w-full" 
          autocomplete="off">
        <input type="hidden" id="student-id" name="student_id">
        
        <!-- Suggestions Dropdown -->
        <ul id="student-suggestions" class="absolute z-50 bg-white max-h-96 overflow-auto hidden" style="list-style:none;padding:0;margin:0;"></ul>
      </div>
      
      <!-- Selected Student Badge -->
      <div id="selected-student-container"></div>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">Ù…Ø¶Ø§Ù…ÛŒÙ† (Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯)</label>
      <div id="subjects-container" class="mt-2">
        <p id="subjects-note" class="text-sm text-gray-500 mb-2">Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø§Ø² ÙÛŒÙ„Ø¯ "Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²" ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ø¶Ø§Ù…ÛŒÙ† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø³Ù…Ø³ØªØ± Ø§Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯.</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 hidden" id="subjects-list">
          {% for sub in subjects %}
          <div class="flex items-center gap-3 p-2 border rounded-md subject-item" data-sub-id="{{ sub.id }}" data-sub-semester="{{ sub.semester }}">
            <input type="checkbox" class="subject-checkbox" id="sub-{{ sub.id }}" data-sub-id="{{ sub.id }}" disabled>
            <label for="sub-{{ sub.id }}" class="flex-1">{{ sub.name }} <span class="text-xs text-gray-400">(Ø³Ù…Ø³ØªØ± {{ sub.semester }})</span></label>
            <input type="number" min="0" max="100" class="score-input w-24 border rounded px-2 py-1" placeholder="Ù†Ù…Ø±Ù‡" data-sub-id="{{ sub.id }}" disabled>
          </div>
          {% empty %}
          <p class="text-sm text-gray-500">Ù…Ø¶Ù…ÙˆÙ† ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
          {% endfor %}
        </div>
        <p id="no-subjects-message" class="text-sm text-red-500 hidden">Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ù‡ÛŒÚ† Ù…Ø¶Ù…ÙˆÙ†ÛŒ Ø¯Ø± Ø³Ù…Ø³ØªØ±(Ù‡Ø§) Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
      </div>
    </div>

    <!-- hidden containers to be filled before submit -->
    <div id="hidden-fields"></div>

    <div class="pt-2 flex items-center gap-3">
      <button type="submit" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">Ø«Ø¨Øª Ù†Ù…Ø±Ø§Øª</button>
      <a href="{% url 'core:dashboard' %}" class="inline-flex items-center gap-2 border border-gray-300 px-4 py-2 rounded-md text-gray-700">Ø§Ù†ØµØ±Ø§Ù</a>
    </div>
    {% if saved_subjects %}
    <div id="saved-summary" class="mt-4 p-3 border-l-4 border-green-500 bg-green-50 rounded">
      {% for st in students %}
        {% if st.id == saved_student_id %}
          <div class="text-sm text-gray-700">
            <strong>Ù†Ù…Ø±Ø§Øª Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ:</strong> {{ st.display }}
          </div>
        {% endif %}
      {% endfor %}
      <ul class="mt-2 list-disc list-inside text-sm text-gray-700">
        {% for ss in saved_subjects %}
          <li>{{ ss.name }} â€” {% if ss.score %}{{ ss.score }}{% else %}â€”{% endif %} <span class="text-xs text-gray-500">({{ ss.op }})</span></li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </form>
</div>

{% if students %}
  {{ students|json_script:"studentsData" }}
{% else %}
  <script id="studentsData" type="application/json">[]</script>
{% endif %}

{% block extra_js %}
<script>
  (function(){
  // Students list injected by view as JSON script. Read and parse it.
  const rawStudents = document.getElementById('studentsData') && document.getElementById('studentsData').textContent;
  let students = [];
  try { students = rawStudents ? JSON.parse(rawStudents) : []; } catch(e) { students = []; }
    const studentInput = document.getElementById('student-display');
    const suggestions = document.getElementById('student-suggestions');
    const studentIdField = document.getElementById('student-id');
    const subjectsContainer = document.getElementById('subjects-container');
    const subjectsList = document.getElementById('subjects-list');
    const subjectsNote = document.getElementById('subjects-note');
    const noSubjectsMsg = document.getElementById('no-subjects-message');

    // Initially ensure subjects list hidden and checkboxes disabled (markup sets disabled),
    // but make sure JS state is consistent.
    function resetSubjectsVisibility(){
      subjectsList.classList.add('hidden');
      noSubjectsMsg.classList.add('hidden');
      subjectsNote.classList.remove('hidden');
      // disable and uncheck everything
      const items = Array.from(document.querySelectorAll('.subject-item'));
      items.forEach(it => {
        it.style.display = 'none';
        const cb = it.querySelector('.subject-checkbox');
        const si = it.querySelector('.score-input');
        if (cb){ cb.checked = false; cb.disabled = true; }
        if (si){ si.value = ''; si.disabled = true; }
      });
    }

    resetSubjectsVisibility();

    function renderStudentList(list){
      suggestions.innerHTML = '';
      if (!list.length){ 
        suggestions.innerHTML = `
          <div class="no-results-message">
            <div class="no-results-icon">ğŸ”</div>
            <div style="font-size: 15px; font-weight: 500; margin-bottom: 4px;">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>
            <div style="font-size: 13px; color: #9ca3af;">Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯</div>
          </div>
        `;
        suggestions.classList.remove('hidden');
        return;
      }
      
      list.forEach(s => {
        const li = document.createElement('li');
        li.className = 'student-suggestion-item';
        li.dataset.id = s.id;
        
        // Create info container
        const info = document.createElement('div');
        info.className = 'student-info';
        
        const name = document.createElement('div');
        name.className = 'student-name';
        name.textContent = s.display;
        
        const meta = document.createElement('div');
        meta.className = 'student-meta';
        const metaParts = [];
        if (s.class_name) metaParts.push(`ØµÙ†Ù: ${s.class_name}`);
        if (s.semesters && s.semesters.length) metaParts.push(`Ø³Ù…Ø³ØªØ±: ${s.semesters.join(', ')}`);
        meta.textContent = metaParts.length ? metaParts.join(' â€¢ ') : 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
        
        info.appendChild(name);
        info.appendChild(meta);
        
        // Create check icon (shown when selected)
        const checkIcon = document.createElement('svg');
        checkIcon.className = 'w-5 h-5 text-blue-600 flex-shrink-0';
        checkIcon.style.display = 'none';
        checkIcon.setAttribute('fill', 'currentColor');
        checkIcon.setAttribute('viewBox', '0 0 20 20');
        checkIcon.innerHTML = '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>';
        
        li.appendChild(info);
        li.appendChild(checkIcon);
        
        li.addEventListener('click', function(){
          const selectedName = s.display;
          studentInput.value = selectedName;
          studentIdField.value = this.dataset.id;
          suggestions.classList.add('hidden');
          
          // Show selected student badge
          const badgeContainer = document.getElementById('selected-student-container');
          badgeContainer.innerHTML = `
            <div class="selected-student-badge">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
              </svg>
              <span>${selectedName}</span>
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            </div>
          `;
          
          // find selected student object to access semesters
          const st = students.find(x => String(x.id) === String(this.dataset.id));
          const sems = (st && st.semesters && st.semesters.length) ? st.semesters.map(Number) : [];
          filterSubjectsBySemesters(sems);
        });
        
        suggestions.appendChild(li);
      });
      suggestions.classList.remove('hidden');
    }

    function filterSubjectsBySemesters(sems){
      // sems: array of numbers; if empty -> student has no semesters assigned
      const items = Array.from(document.querySelectorAll('.subject-item'));
      // if student has no semesters, show message and keep list hidden
      if (!sems || sems.length === 0){
        subjectsList.classList.add('hidden');
        noSubjectsMsg.classList.remove('hidden');
        subjectsNote.classList.add('hidden');
        // disable all controls
        items.forEach(it => {
          it.style.display = 'none';
          const cb = it.querySelector('.subject-checkbox');
          const si = it.querySelector('.score-input');
          if (cb){ cb.checked = false; cb.disabled = true; }
          if (si){ si.value = ''; si.disabled = true; }
        });
        return;
      }

      // show container and hide the instruction note
      subjectsList.classList.remove('hidden');
      subjectsNote.classList.add('hidden');
      noSubjectsMsg.classList.add('hidden');

      let anyVisible = false;
      items.forEach(it => {
        const s = Number(it.dataset.subSemester || it.getAttribute('data-sub-semester'));
        const cb = it.querySelector('.subject-checkbox');
        const si = it.querySelector('.score-input');
        if (sems.includes(s)){
          it.style.display = '';
          if (cb){ cb.disabled = false; }
          // keep score input disabled until checkbox checked
          if (si){ si.disabled = true; si.value = ''; }
          anyVisible = true;
        } else {
          // uncheck and disable inputs if hidden
          if (cb){ cb.checked = false; cb.disabled = true; }
          if (si){ si.value = ''; si.disabled = true; }
          it.style.display = 'none';
        }
      });

      if (!anyVisible){
        subjectsList.classList.add('hidden');
        noSubjectsMsg.classList.remove('hidden');
      }
    }

    studentInput.addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      if (!q){ suggestions.classList.add('hidden'); studentIdField.value = ''; resetSubjectsVisibility(); return; }
      const matches = students.filter(s => s.display.toLowerCase().includes(q));
      renderStudentList(matches.slice(0, 30));
    });

    document.addEventListener('click', function(e){ if (!suggestions.contains(e.target) && e.target !== studentInput) suggestions.classList.add('hidden'); });

    // Subjects selection handling: enable score input when checkbox checked
    // Use delegated listener in case checkboxes are toggled disabled->enabled
    document.addEventListener('change', function(ev){
      const el = ev.target;
      if (el && el.classList && el.classList.contains('subject-checkbox')){
        const id = el.dataset.subId;
        const input = document.querySelector('.score-input[data-sub-id="'+id+'"]');
        if (el.checked){ input.disabled = false; input.focus(); }
        else { input.disabled = true; input.value = ''; }
      }
    });

    // Before submit, collect selected subjects and scores into hidden inputs
    const form = document.getElementById('grades-form');
    form.addEventListener('submit', function(e){
      // ensure a student selected
      if (!studentIdField.value){
        e.preventDefault();
        alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ø² Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
        studentInput.focus();
        return false;
      }
      const hidden = document.getElementById('hidden-fields');
      hidden.innerHTML = '';

      const checkboxes = Array.from(document.querySelectorAll('.subject-checkbox'));
      const selected = checkboxes.filter(c => c.checked && !c.disabled);
      if (!selected.length){
        if (!confirm('Ø´Ù…Ø§ Ù‡ÛŒÚ† Ù…ÙˆØ¶ÙˆØ¹ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ØŸ')){
          e.preventDefault(); return false;
        }
      }

      selected.forEach((c, idx) => {
        const sid = c.dataset.subId;
        const scoreInput = document.querySelector('.score-input[data-sub-id="'+sid+'"]');
        const sVal = scoreInput ? scoreInput.value.trim() : '';
        // create hidden inputs subject_ids[] and scores[] keeping order
        const hi = document.createElement('input'); hi.type = 'hidden'; hi.name = 'subject_ids[]'; hi.value = sid; hidden.appendChild(hi);
        const hs = document.createElement('input'); hs.type = 'hidden'; hs.name = 'scores[]'; hs.value = sVal; hidden.appendChild(hs);
      });

      // allow submission: server will validate values
    });

  })();
</script>
{% endblock %}

{% endblock %}
