{% extends 'core/base.html' %}
{% load static form_tags %}

{% block content %}
  <div class="bg-white p-6 rounded-xl shadow-md ring-1 ring-gray-200">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold">ثبت استاد جدید</h2>
        <p class="text-sm text-gray-500">فرم ثبت اطلاعات اساتید مرکز</p>
      </div>
      <div class="hidden sm:flex items-center gap-3">
        <a href="{% url 'core:teacher_list' %}" class="text-sm text-blue-600 hover:underline">بازگشت به لیست</a>
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
      {% csrf_token %}

      <!-- Left: image upload -->
      <div class="md:col-span-1 flex flex-col items-center">
        <label class="block text-sm font-medium text-gray-700 mb-3">عکس استاد</label>

        <div class="w-44 h-44 bg-gray-50 rounded-lg flex items-center justify-center overflow-hidden border border-dashed border-gray-200">
          <img id="preview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><rect fill='%23f3f4f6' width='200' height='200'/><g transform='translate(50,30)'><circle cx='50' cy='40' r='30' fill='%23e5e7eb'/><rect x='20' y='90' width='60' height='20' rx='10' fill='%23e5e7eb'/></g></svg>" alt="پیش‌نمایش" class="w-full h-full object-cover" />
        </div>

        <label for="id_image" class="mt-3 w-full inline-flex justify-center items-center px-3 py-2 bg-white border rounded-md text-sm text-gray-700 hover:bg-gray-50 cursor-pointer">
          انتخاب فایل
        </label>
        {{ form.image }}

        <p class="text-xs text-gray-400 mt-2">فرمت‌های مجاز: JPG, PNG — حداکثر 2MB</p>
      </div>

      <!-- Right: inputs -->
      <div class="md:col-span-2 space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">نام و تخلص استاد</label>
            {{ form.name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.name.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.name.errors|striptags }}</p>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">نام پدر</label>
            {{ form.father_name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.father_name.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.father_name.errors|striptags }}</p>
            {% endif %}
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">سکونت اصلی</label>
            {{ form.permanent_address|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">سکونت فعلی</label>
            {{ form.current_address|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">جنسیت</label>
            {{ form.gender|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm' }}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">سویه تحصیلی</label>
            {{ form.education_level|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm' }}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">نمبر تذکره</label>
            {{ form.id_number|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm' }}
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">صنوف (جستجو و انتخاب)</label>
          <div class="mt-1">
            <input id="class_search_input" type="text" placeholder="جستجو صنف" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
            <div id="selected_classes" class="mt-2 flex flex-wrap gap-2"></div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">مضامین (جستجو و انتخاب)</label>
          <div class="mt-1">
            <input id="subject_search_input" type="text" placeholder="جستجو مضمون" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
            <div id="selected_subjects" class="mt-2 flex flex-wrap gap-2"></div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">سمسترها (انتخاب یک یا چند مورد)</label>
          <div class="mt-1">
            <input id="semester_search_input" type="text" placeholder="جستجو سمستر (۱ ۲ ۳ ۴)" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
            <div id="selected_semesters" class="mt-2 flex flex-wrap gap-2"></div>
          </div>
        </div>

        <div class="pt-2 flex items-center gap-3">
          <button type="submit" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">ثبت استاد</button>
          <a href="{% url 'core:teacher_list' %}" class="inline-flex items-center gap-2 border border-gray-300 px-4 py-2 rounded-md text-gray-700">انصراف</a>
        </div>
      </div>
    </form>
  </div>

  {# Embed class and subject names and semester options as JSON for client-side search #}
  {% if class_names %}
    {{ class_names|json_script:"classNames" }}
  {% else %}
    <script id="classNames" type="application/json">[]</script>
  {% endif %}

  {% if subject_names %}
    {{ subject_names|json_script:"subjectNames" }}
  {% else %}
    <script id="subjectNames" type="application/json">[]</script>
  {% endif %}

  {% if semester_names %}
    {{ semester_names|json_script:"semesterNames" }}
  {% else %}
    <script id="semesterNames" type="application/json">[]</script>
  {% endif %}

  {% if teacher_classes %}
    {{ teacher_classes|json_script:"teacherClasses" }}
  {% else %}
    <script id="teacherClasses" type="application/json">[]</script>
  {% endif %}

  {% if teacher_subjects %}
    {{ teacher_subjects|json_script:"teacherSubjects" }}
  {% else %}
    <script id="teacherSubjects" type="application/json">[]</script>
  {% endif %}

  {% if teacher_semesters %}
    {{ teacher_semesters|json_script:"teacherSemesters" }}
  {% else %}
    <script id="teacherSemesters" type="application/json">[]</script>
  {% endif %}

{% block extra_js %}
<script>
  (function(){
    // image preview (same as student form)
    const fileInput = document.querySelector('#id_image');
    const preview = document.getElementById('preview');
    if (fileInput && preview) {
      fileInput.classList.add('hidden');
      fileInput.addEventListener('change', function(){
        const file = this.files && this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev){ preview.src = ev.target.result; };
        reader.readAsDataURL(file);
      });
    }

    // simple tag selector used for classes, subjects and semesters
    function setupTagInput(searchInputId, selectedContainerId, listScriptId, hiddenInputName, preselected){
      const raw = document.getElementById(listScriptId) && document.getElementById(listScriptId).textContent;
      let items = [];
      try { items = raw ? JSON.parse(raw) : []; } catch(e){ items = []; }

      const input = document.getElementById(searchInputId);
      const container = document.getElementById(selectedContainerId);
      if (!input || !container) return;

      const suggestions = document.createElement('ul');
      suggestions.className = 'absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow max-h-60 overflow-auto hidden';
      suggestions.style.listStyle = 'none'; suggestions.style.padding = '0'; suggestions.style.margin = '0';
      input.parentNode.style.position = 'relative';
      input.parentNode.appendChild(suggestions);

      function renderList(matches){
        suggestions.innerHTML = '';
        if (!matches.length){ suggestions.classList.add('hidden'); return; }
        matches.slice(0,20).forEach(item => {
          const li = document.createElement('li'); li.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
          const label = (typeof item === 'object' && item.label) ? item.label : item;
          li.textContent = label;
          li.addEventListener('click', function(){ addTag(item); suggestions.classList.add('hidden'); input.value = ''; });
          suggestions.appendChild(li);
        });
        suggestions.classList.remove('hidden');
      }

      function addTag(item){
        const value = (typeof item === 'object' && item.value) ? item.value : item;
        const label = (typeof item === 'object' && item.label) ? item.label : item;
        if (Array.from(container.querySelectorAll('input[type=hidden]')).some(i=>i.value===String(value))) return;
        const tag = document.createElement('span'); tag.className='inline-flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-full text-sm'; tag.textContent=label;
        const removeBtn = document.createElement('button'); removeBtn.type='button'; removeBtn.className='ml-2 text-xs text-red-600'; removeBtn.textContent='×';
        const hidden = document.createElement('input'); hidden.type='hidden'; hidden.name = hiddenInputName; hidden.value = String(value);
        removeBtn.addEventListener('click', function(){ tag.remove(); hidden.remove(); });
        tag.appendChild(removeBtn); container.appendChild(tag); container.appendChild(hidden);
      }

      input.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase(); if (!q){ suggestions.classList.add('hidden'); return; }
        const matches = items.filter(n => { const label = (typeof n==='object' && n.label)? n.label : n; return String(label).toLowerCase().includes(q); });
        renderList(matches);
      });

      document.addEventListener('click', function(e){ if (!input.parentNode.contains(e.target)) suggestions.classList.add('hidden'); });

      // prepopulate
      try{ const pre = preselected || []; pre.forEach(v => {
        const found = items.find(i => (typeof i==='object'? String(i.value)===String(v) : String(i)===String(v)));
        if (found) addTag(found); else addTag(v);
      }); }catch(e){}
    }

    const classNamesRaw = document.getElementById('classNames') && document.getElementById('classNames').textContent;
    const subjectNamesRaw = document.getElementById('subjectNames') && document.getElementById('subjectNames').textContent;
    const semesterNamesRaw = document.getElementById('semesterNames') && document.getElementById('semesterNames').textContent;
    const teacherClassesRaw = document.getElementById('teacherClasses') && document.getElementById('teacherClasses').textContent;
    const teacherSubjectsRaw = document.getElementById('teacherSubjects') && document.getElementById('teacherSubjects').textContent;
    const teacherSemestersRaw = document.getElementById('teacherSemesters') && document.getElementById('teacherSemesters').textContent;

    let classNames=[], subjectNames=[], semesterNames=[], teacherClasses=[], teacherSubjects=[], teacherSemesters=[];
    try{ classNames = classNamesRaw? JSON.parse(classNamesRaw): []; }catch(e){ classNames = []; }
    try{ subjectNames = subjectNamesRaw? JSON.parse(subjectNamesRaw): []; }catch(e){ subjectNames = []; }
    try{ semesterNames = semesterNamesRaw? JSON.parse(semesterNamesRaw): []; }catch(e){ semesterNames = []; }
    try{ teacherClasses = teacherClassesRaw? JSON.parse(teacherClassesRaw): []; }catch(e){ teacherClasses = []; }
    try{ teacherSubjects = teacherSubjectsRaw? JSON.parse(teacherSubjectsRaw): []; }catch(e){ teacherSubjects = []; }
    try{ teacherSemesters = teacherSemestersRaw? JSON.parse(teacherSemestersRaw): []; }catch(e){ teacherSemesters = []; }

    setupTagInput('class_search_input','selected_classes','classNames','classes', teacherClasses);
    setupTagInput('subject_search_input','selected_subjects','subjectNames','subjects', teacherSubjects);
    setupTagInput('semester_search_input','selected_semesters','semesterNames','semesters', teacherSemesters);

  })();
</script>
{% endblock %}

{% endblock %}
