{% extends 'core/base.html' %}
{% load static form_tags %}

{% block content %}
  <div class="bg-white p-6 rounded-xl shadow-md">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold">قرارداد استاد</h2>
        <p class="text-sm text-gray-500">مشخصات قرارداد را وارد کنید و فایل PDF را دریافت نمایید.</p>
      </div>
      <div class="hidden sm:flex items-center gap-3">
        <a href="{% url 'core:teacher_list' %}" class="text-sm text-blue-600 hover:underline">بازگشت به لیست</a>
        <a href="{% url 'core:teacher_edit' teacher.pk %}" class="text-sm text-blue-600 hover:underline">ویرایش استاد</a>
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="contract-form grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
      {% csrf_token %}

      <div class="space-y-4">
        <div class="bg-gray-50/50 border border-gray-200 rounded-xl p-4">
          <h3 class="text-sm font-semibold text-gray-700 mb-3">مشخصات استاد</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
            <div><span class="text-gray-500">نام:</span> <span class="text-gray-900">{{ teacher.name }}</span></div>
            <div><span class="text-gray-500">نام پدر:</span> <span class="text-gray-900">{{ teacher.father_name|default:'—' }}</span></div>
            <div><span class="text-gray-500">تذکره:</span> <span class="text-gray-900">{{ teacher.id_number|default:'—' }}</span></div>
            <div><span class="text-gray-500">سویه تحصیلی:</span> <span class="text-gray-900">{{ teacher.get_education_level_display }}</span></div>
            <div><span class="text-gray-500">سطوح تدریس:</span> <span class="text-gray-900">{{ teacher_levels }}</span></div>
            <div><span class="text-gray-500">سمسترها:</span> <span class="text-gray-900">{{ teacher_semesters }}</span></div>
            <div><span class="text-gray-500">دوره‌ها:</span> <span class="text-gray-900">{{ teacher_periods }}</span></div>
            <div><span class="text-gray-500">مضامین:</span> <span class="text-gray-900">{{ teacher_subjects }}</span></div>
            <div><span class="text-gray-500">صنوف:</span> <span class="text-gray-900">{{ teacher_classes }}</span></div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">شماره قرارداد</label>
            {{ form.contract_number }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">تاریخ قرارداد</label>
            {{ form.contract_date }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">تاریخ شروع</label>
            {{ form.start_date }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">تاریخ ختم</label>
            {{ form.end_date }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">معاش ماهوار</label>
            {{ form.monthly_salary }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">وظیفه/سمت</label>
            {{ form.position }}
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm font-medium text-gray-700">ساعات کاری</label>
            {{ form.work_hours }}
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">شرایط و توضیحات</label>
          {{ form.terms }}
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">فایل قرارداد امضاشده (پس از امضا و اسکن)</label>
          {{ form.signed_file }}
          {% if contract.signed_file %}
            <p class="text-xs text-gray-500 mt-2">
              فایل فعلی: <a href="{{ contract.signed_file.url }}" class="text-blue-600 hover:underline">دانلود قرارداد امضاشده</a>
            </p>
          {% endif %}
        </div>

        <div class="pt-2 flex flex-wrap items-center gap-3">
          <button type="submit" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">ذخیره قرارداد</button>
          <button type="button" id="download-pdf-btn" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md shadow">دانلود PDF</button>
        </div>
      </div>

      <div>
        <div id="contract-preview" class="contract-paper p-8">
          <div class="contract-header">
            <div class="contract-logo">
              <img src="{% url 'core:logo' %}" alt="لوگو" />
            </div>
            <div class="contract-org">
              <div class="contract-org-title">دارالعلوم عالی الحاج سید منصور نادری</div>
              <div class="contract-org-subtitle">قرارداد همکاری استاد</div>
            </div>
            <div class="contract-meta">
              <div>شماره قرارداد: <span id="preview-contract-number" class="contract-value">{{ contract.contract_number|default:'—' }}</span></div>
              <div>تاریخ: <span id="preview-contract-date" class="contract-value">{% if contract.contract_date %}{{ contract.contract_date|date:"Y/m/d" }}{% else %}—{% endif %}</span></div>
            </div>
          </div>
          <div class="contract-divider"></div>

          <div class="mt-6 text-sm leading-7">
            <p>
              این قرارداد فی‌مابین دارالعلوم عالی الحاج سید منصور نادری (طرف اول)
              و استاد <span class="contract-value">{{ teacher.name }}</span>
              فرزند <span class="contract-value">{{ teacher.father_name|default:'—' }}</span>
              با نمبر تذکره <span class="contract-value">{{ teacher.id_number|default:'—' }}</span>
              (طرف دوم) منعقد می‌گردد.
            </p>
            <p class="mt-3">
              سویه تحصیلی: <span class="contract-value">{{ teacher.get_education_level_display }}</span> |
              سطوح تدریس: <span class="contract-value">{{ teacher_levels }}</span> |
              مضامین: <span class="contract-value">{{ teacher_subjects }}</span>
            </p>
            <p class="mt-3">
              مدت قرارداد از
              <span id="preview-start-date" class="contract-value">{% if contract.start_date %}{{ contract.start_date|date:"Y/m/d" }}{% else %}—{% endif %}</span>
              الی
              <span id="preview-end-date" class="contract-value">{% if contract.end_date %}{{ contract.end_date|date:"Y/m/d" }}{% else %}—{% endif %}</span>
              می‌باشد.
            </p>
            <p class="mt-3">
              معاش ماهوار: <span id="preview-salary" class="contract-value">{{ contract.monthly_salary|default:'—' }}</span> |
              وظیفه/سمت: <span id="preview-position" class="contract-value">{{ contract.position|default:'—' }}</span> |
              ساعات کاری: <span id="preview-work-hours" class="contract-value">{{ contract.work_hours|default:'—' }}</span>
            </p>
            <p class="mt-4 font-semibold">شرایط و توضیحات:</p>
            <p id="preview-terms" data-default-terms="{{ default_terms }}" class="mt-1 whitespace-pre-line">
              {{ contract.terms|default:default_terms }}
            </p>
          </div>

          <div class="mt-10 grid grid-cols-2 gap-8 text-center text-sm">
            <div class="contract-signature">
              <div class="contract-sign-line"></div>
              <div class="mt-2">امضای استاد</div>
            </div>
            <div class="contract-signature">
              <div class="contract-sign-line"></div>
              <div class="mt-2">امضای مقام دارالعلوم</div>
            </div>
          </div>
          <div class="contract-stamp">محل مهر رسمی</div>
        </div>
        <p class="text-xs text-gray-500 mt-3">برای چاپ، از دکمه «دانلود PDF» استفاده کنید. اگر متن خیلی طولانی باشد، PDF کوچک می‌شود.</p>
      </div>
    </form>
  </div>

  <style>
    .contract-paper {
      background: #ffffff;
      color: #0f172a;
      direction: rtl;
      width: 100%;
      max-width: 794px;
      height: auto;
      aspect-ratio: 210 / 297;
      margin: 0 auto;
      position: relative;
    }
    .contract-paper .contract-value {
      color: #0f172a;
      font-weight: 700;
    }
    .contract-header {
      display: grid;
      grid-template-columns: 100px 1fr 220px;
      align-items: center;
      gap: 12px;
    }
    .contract-logo {
      width: 96px;
      height: 96px;
      border: 1px solid #0f172a;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #ffffff;
    }
    .contract-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 8px;
    }
    .contract-org {
      text-align: center;
    }
    .contract-org-title {
      font-size: 18px;
      font-weight: 700;
    }
    .contract-org-subtitle {
      font-size: 14px;
      color: #334155;
      margin-top: 6px;
    }
    .contract-meta {
      text-align: right;
      font-size: 12px;
      line-height: 1.6;
      color: #334155;
      border: 1px solid #0f172a;
      padding: 10px 12px;
      border-radius: 8px;
    }
    .contract-divider {
      margin-top: 16px;
      border-top: 2px solid #0f172a;
    }
    .contract-signature {
      border: 1px dashed #64748b;
      padding: 16px 12px;
      border-radius: 10px;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
    }
    .contract-sign-line {
      width: 80%;
      border-top: 1px solid #0f172a;
    }
    .contract-stamp {
      position: absolute;
      left: 40px;
      bottom: 40px;
      width: 140px;
      height: 140px;
      border: 2px dashed #e5e7eb;
      color: #e5e7eb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }
    .contract-form input,
    .contract-form textarea,
    .contract-form select {
      color: #0f172a;
    }
    .contract-form input::placeholder,
    .contract-form textarea::placeholder {
      color: #94a3b8;
    }
    html.dark .contract-form input,
    html.dark .contract-form textarea,
    html.dark .contract-form select {
      color: #e2e8f0;
      background-color: #0f172a;
      border-color: #334155;
    }
    html.dark .contract-form input::placeholder,
    html.dark .contract-form textarea::placeholder {
      color: #94a3b8;
    }
    html.dark .contract-paper {
      background: #ffffff;
      color: #0f172a;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    (function(){
      const bindings = [
        { input: 'id_contract_number', output: 'preview-contract-number', fallback: '—' },
        { input: 'id_contract_date', output: 'preview-contract-date', fallback: '—', isDate: true },
        { input: 'id_start_date', output: 'preview-start-date', fallback: '—', isDate: true },
        { input: 'id_end_date', output: 'preview-end-date', fallback: '—', isDate: true },
        { input: 'id_monthly_salary', output: 'preview-salary', fallback: '—' },
        { input: 'id_position', output: 'preview-position', fallback: '—' },
        { input: 'id_work_hours', output: 'preview-work-hours', fallback: '—' }
      ];

      function normalizeDate(value) {
        if (!value) return '';
        return value.replace(/-/g, '/');
      }

      function setPreview(outputId, value, fallback, isDate) {
        const el = document.getElementById(outputId);
        if (!el) return;
        let text = value && value.trim() ? value.trim() : '';
        if (isDate) {
          text = text ? normalizeDate(text) : '';
        }
        el.textContent = text || fallback;
      }

      function updatePreview() {
        bindings.forEach(({input, output, fallback, isDate}) => {
          const inputEl = document.getElementById(input);
          const value = inputEl ? inputEl.value : '';
          setPreview(output, value, fallback, isDate);
        });
        const termsEl = document.getElementById('id_terms');
        const termsPreview = document.getElementById('preview-terms');
        if (termsPreview) {
          const fallback = termsPreview.getAttribute('data-default-terms') || '—';
          const text = termsEl && termsEl.value && termsEl.value.trim() ? termsEl.value.trim() : fallback;
          termsPreview.textContent = text;
        }
      }

      bindings.forEach(({input}) => {
        const inputEl = document.getElementById(input);
        if (inputEl) {
          inputEl.addEventListener('input', updatePreview);
          inputEl.addEventListener('change', updatePreview);
        }
      });
      const termsInput = document.getElementById('id_terms');
      if (termsInput) {
        termsInput.addEventListener('input', updatePreview);
        termsInput.addEventListener('change', updatePreview);
      }
      updatePreview();

      const downloadBtn = document.getElementById('download-pdf-btn');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', async function(){
          const preview = document.getElementById('contract-preview');
          if (!preview) return;
          try {
            const canvas = await html2canvas(preview, { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf || window;
            if (!jsPDF) {
              alert('کتابخانه PDF بارگذاری نشد.');
              return;
            }
            const pdf = new jsPDF('p', 'pt', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
            const imgWidth = canvas.width * ratio;
            const imgHeight = canvas.height * ratio;
            const x = (pageWidth - imgWidth) / 2;
            const y = 20;
            pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
            pdf.save('teacher-contract-{{ teacher.pk }}.pdf');
          } catch (err) {
            console.error(err);
            alert('خطا در ساخت PDF. لطفاً دوباره تلاش کنید.');
          }
        });
      }
    })();
  </script>
{% endblock %}
